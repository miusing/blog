"use strict";(self.webpackChunkakara=self.webpackChunkakara||[]).push([[9552],{4544:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>a,toc:()=>i});const a=JSON.parse('{"id":"javascript/AJAX","title":"Ajax And Fetch","description":"Ajax","source":"@site/docs/javascript/AJAX.md","sourceDirName":"javascript","slug":"/javascript/AJAX","permalink":"/docs/javascript/AJAX","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/javascript/AJAX.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Set And Map","permalink":"/docs/javascript/Set-Map"},"next":{"title":"BOM","permalink":"/docs/javascript/BOM"}}');var r=t(4848),s=t(8453);const l={},c="Ajax And Fetch",o={},i=[{value:"Ajax",id:"ajax",level:2},{value:"With Callback",id:"with-callback",level:3},{value:"With Promise",id:"with-promise",level:3},{value:"With Generator",id:"with-generator",level:3},{value:"With Generator + Co",id:"with-generator--co",level:3},{value:"With Async",id:"with-async",level:3},{value:"Axios",id:"axios",level:3},{value:"fetch",id:"fetch",level:2},{value:"Diff with Ajax",id:"diff-with-ajax",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"ajax-and-fetch",children:"Ajax And Fetch"})}),"\n",(0,r.jsx)(n.h2,{id:"ajax",children:"Ajax"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"let xhr = new XMLHttpRequest()\nxhr.onreadystatechange = function () {\n    if (xhr.readyState === 4) {\n\n    }\n}\n\nxhr.onprogress = function (event) {\n    if (event.lengthComputable) {\n     \tvar complete = (event.loaded / event.total * 100 | 0);\n      \tprogress.value = complete;\n    }\n}\nxhr.open('get', '/getInfo')\n// \u8bbe\u7f6e\u8bf7\u6c42\u5934\nxhr.setRequestHeader()\n// \u8d85\u65f6\u63a7\u5236\nxhr.timeout =\nxhr.ontimeout = function () {}\n// \u4e2d\u6b62\u8bf7\u6c42\nxhr.abort()\n// \u53d1\u9001\u8bf7\u6c42\nxhr.send()\n"})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"readyState"}),(0,r.jsx)(n.th,{children:"\u63cf\u8ff0"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"0"}),(0,r.jsx)(n.td,{children:"XHR\u5df2\u7ecf\u521b\u5efa\uff0c\u4f46\u672a\u8c03\u7528open()\u65b9\u6cd5"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"1"}),(0,r.jsx)(n.td,{children:"open()\u65b9\u6cd5\u5df2\u7ecf\u88ab\u8c03\u7528"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"2"}),(0,r.jsx)(n.td,{children:"send() \u65b9\u6cd5\u5df2\u7ecf\u88ab\u8c03\u7528"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"3"}),(0,r.jsx)(n.td,{children:"\u6b63\u5728\u63a5\u6536\u54cd\u5e94\u7684\u5185\u5bb9"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"4"}),(0,r.jsx)(n.td,{children:"\u6210\u529f\u63a5\u6536\u5230\u54cd\u5e94"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"with-callback",children:"With Callback"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"const Ajax = ({\n    method = 'get',\n    url = '/',\n    data,\n    async = true\n}, callback) => {\n    let xhr = new XMLHttpRequest()\n    xhr.onreadystatechange = () => {\n        if (xhr.readyState === 4 && xhr.status === 200) {\n            let res = JSON.parse(xhr.responseText)\n            callback(res)\n        }\n    }\n    xhr.open(method, url, async)\n    if (method === 'get') {\n        xhr.send()\n    }\n    if (method === 'post') {\n        let type = typeof data\n        let header\n        if (type === 'string') {\n            header = 'application/x-www-form-urlencoded'\n        }\n        else {\n            header = 'application/json'\n            data = JSON.stringify(data)\n        }\n        xhr.setRequestHeader('Content-type', header)\n        xhr.send(data)\n    }\n}\n\nAjax.get = (url, callback) => {\n    return Ajax({\n        url\n    }, callback)\n}\n\n\nAjax.post = function (url, data, callback) {\n    return Ajax({\n        method: 'post',\n        url,\n        data,\n    }, callback)\n}\n\nAjax.get('http://localhost:3000/getData', (res) => {\n    console.log(res)\n})\n"})}),"\n",(0,r.jsx)(n.h3,{id:"with-promise",children:"With Promise"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"const Ajax = ({\n    method = 'get',\n    url = '/',\n    data,\n    async = true\n}) => {\n    return new Promise((resolve, reject) => {\n        let xhr = new XMLHttpRequest()\n        xhr.onreadystatechange = () => {\n            if (xhr.readyState === 4 && xhr.status === 200) {\n                let res = JSON.parse(xhr.responseText)\n                resolve(res)\n            }\n        }\n        xhr.open(method, url, async)\n        if (method === 'get') {\n            xhr.send()\n        }\n        if (method === 'post') {\n            let type = typeof data\n            let header\n            if (type === 'string') {\n                header = 'application/x-www-form-urlencoded'\n            }\n            else {\n                header = 'application/json'\n                data = JSON.stringify(data)\n            }\n            xhr.setRequestHeader('Content-type', header)\n            xhr.send(data)\n        }\n    })\n}\n\nAjax.get = (url) => {\n    return Ajax({\n        url\n    })\n}\n\n\n\nAjax.get('http://localhost:3000/getData')\n    .then((data) => {\n        console.log(data)\n    })\n"})}),"\n",(0,r.jsx)(n.h3,{id:"with-generator",children:"With Generator"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"const Ajax = ({\n    method = 'get',\n    url = '/',\n    data,\n    async = true\n}) => {\n    return new Promise((resolve, reject) => {\n        let xhr = new XMLHttpRequest()\n        xhr.onreadystatechange = () => {\n            if (xhr.readyState === 4 && xhr.status === 200) {\n                let res = JSON.parse(xhr.responseText)\n                resolve(res)\n            }\n        }\n        xhr.open(method, url, async)\n        if (method === 'get') {\n            xhr.send()\n        }\n        if (method === 'post') {\n            let type = typeof data\n            let header\n            if (type === 'string') {\n                header = 'application/x-www-form-urlencoded'\n            }\n            else {\n                header = 'application/json'\n                data = JSON.stringify(data)\n            }\n            xhr.setRequestHeader('Content-type', header)\n            xhr.send(data)\n        }\n    })\n}\n\nAjax.get = (url) => {\n    return Ajax({\n        url\n    })\n}\n\n\nfunction* use() {\n    let data = yield Ajax.get('http://localhost:3000/getData')\n    console.log(data)\n}\n\nlet obj = use()\nobj.next().value.then((res) => {\n    obj.next(res)\n})\n"})}),"\n",(0,r.jsx)(n.h3,{id:"with-generator--co",children:"With Generator + Co"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"const Ajax = ({\n    method = 'get',\n    url = '/',\n    data,\n    async = true\n}) => {\n    return new Promise((resolve, reject) => {\n        let xhr = new XMLHttpRequest()\n        xhr.onreadystatechange = () => {\n            if (xhr.readyState === 4 && xhr.status === 200) {\n                let res = JSON.parse(xhr.responseText)\n                resolve(res)\n            }\n        }\n        xhr.open(method, url, async)\n        if (method === 'get') {\n            xhr.send()\n        }\n        if (method === 'post') {\n            let type = typeof data\n            let header\n            if (type === 'string') {\n                header = 'application/x-www-form-urlencoded'\n            }\n            else {\n                header = 'application/json'\n                data = JSON.stringify(data)\n            }\n            xhr.setRequestHeader('Content-type', header)\n            xhr.send(data)\n        }\n    })\n}\n\nAjax.get = (url) => {\n    return Ajax({\n        url\n    })\n}\n\n\n\nfunction* use() {\n    let data = yield Ajax.get('http://localhost:3000/getData')\n    console.log(data)\n}\n\nco(use)\n"})}),"\n",(0,r.jsx)(n.p,{children:"Co\u6a21\u5757\u7684\u539f\u7406\u7c7b\u4f3c\u5982\u4e0b"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"function co(gen){\n  var g = gen();\n\n  function next(data){\n    var result = g.next(data);\n    if (result.done) return result.value;\n    result.value.then(function(data){\n      next(data);\n    });\n  }\n\n  next();\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"with-async",children:"With Async"}),"\n",(0,r.jsx)(n.p,{children:"\u5176\u5b9easync\u53ef\u4ee5\u770b\u6210Generator + co\u7684\u96c6\u6210\uff0c\u4e0d\u540c\u7684\u662f\u5173\u952e\u5b57\u5206\u522b\u7528async\u548cawait\u4ee3\u66ff\u4e86*\u548cyield\uff0c\u66f4\u52a0\u7684\u8bed\u4e49\u5316\u3002\u9664\u6b64\u4e4b\u5916\uff0casync\u51fd\u6570\u4f1a\u8fd4\u56de\u4e00\u4e2aPromise\u5bf9\u8c61\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"const Ajax = ({\n    method = 'get',\n    url = '/',\n    data,\n    async = true\n}) => {\n    return new Promise((resolve, reject) => {\n        let xhr = new XMLHttpRequest()\n        xhr.onreadystatechange = () => {\n            if (xhr.readyState === 4 && xhr.status === 200) {\n                let res = JSON.parse(xhr.responseText)\n                resolve(res)\n            }\n        }\n        xhr.open(method, url, async)\n        if (method === 'get') {\n            xhr.send()\n        }\n        if (method === 'post') {\n            let type = typeof data\n            let header\n            if (type === 'string') {\n                header = 'application/x-www-form-urlencoded'\n            }\n            else {\n                header = 'application/json'\n                data = JSON.stringify(data)\n            }\n            xhr.setRequestHeader('Content-type', header)\n            xhr.send(data)\n        }\n    })\n\n}\n\nAjax.get = (url) => {\n    return Ajax({url})\n}\n\n\nasync function use() {\n    let data = await Ajax.get('http://localhost:3000/getData')\n    console.log(data)\n}\n\nuse()\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8865\u5145\u4e00\u4e2a\u5e38\u89c1\u7684\u95ee\u9898"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"async function A() { // \u8fd9\u4ee3\u7801\u4e00\u770b\u5c31\u6709\u95ee\u9898\n    let arr = []\n    await fetch()\n    arr.forEach(async item => { \n        await fetch(item)\n    })\n    console.log(1)\n}\n\nasync function A() { // \u5e94\u8be5\u5199\u6210\u8fd9\u6837\n    let arr = []\n    let pArr = []\n    await fetch()\n\tfor (let item of arr) {\n        pArr.push(fetch(item))\n    }    \n    const data = await Promise.all(pArr)\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"axios",children:"Axios"}),"\n",(0,r.jsx)(n.p,{children:"\u53ef\u4ee5\u4f7f\u7528\u73b0\u6210\u7684AJAX\u5e93Axios\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u91c7\u7528\u4e0b\u4e00\u8282\u4ecb\u7ecd\u7684\u6d4f\u89c8\u5668\u81ea\u5e26\u7684Fetch\u6765\u53d1\u8bf7\u6c42"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"axios({\n    method: 'post',\n    url: '/user/12345',\n    data: {\n        firstName: 'Fred',\n        lastName: 'Flintstone'\n    }\n})\n.then(function (response) {\n    console.log(response);\n})\n.catch(function (error) {\n    console.log(error);\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"fetch",children:"fetch"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"fetch(url, options).then(res => res.json()).then(data => console.log(data))\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u901a\u5e38\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528",(0,r.jsx)(n.code,{children:"Content-Disposition: attachment"}),"\u54cd\u5e94\u5934\u90e8\u6765\u4e0b\u8f7d\u8d44\u6e90\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u4e0d\u8fc7\u4f3c\u4e4e\u6211\u4eec\u53ea\u80fd\u9760",(0,r.jsx)(n.code,{children:"a"}),"\u6807\u7b7e/",(0,r.jsx)(n.code,{children:"form"}),"\u8868\u5355/",(0,r.jsx)(n.code,{children:"window.open"}),"\u6765\u4e0b\u8f7d\u8d44\u6e90\uff0c\u5982\u679c\u4f7f\u7528",(0,r.jsx)(n.code,{children:"ajax"}),"/",(0,r.jsx)(n.code,{children:"fetch"}),"\u8bf7\u6c42\u8d44\u6e90\uff0c\u5e76\u4e0d\u4f1a\u9ed8\u8ba4\u4e0b\u8f7d\u8d44\u6e90\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u4e0d\u8fc7\u60f3\u8981\u4f7f\u7528",(0,r.jsx)(n.code,{children:"fetch"}),"\u6765\u4e0b\u8f7d\u8d44\u6e90\u4f9d\u7136\u662f\u6709\u529e\u6cd5\u7684\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"fetch()\n.then(res => res.blob())\n.then(blob => {\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.download = 'example.xlsx';\n    a.href = url;\n    document.body.appendChild(a);\n    a.click();\n})\n"})}),"\n",(0,r.jsx)(n.h3,{id:"diff-with-ajax",children:"Diff with Ajax"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"AJAX\u548cFetch\u53d1\u9001\u540c\u6e90\u8bf7\u6c42\u65f6\u90fd\u9ed8\u8ba4\u643a\u5e26Cookie\uff0c\u8de8\u57df\u8bf7\u6c42\u5219\u90fd\u9ed8\u8ba4\u4e0d\u643a\u5e26Cookie\u3002"}),"\n",(0,r.jsx)(n.p,{children:"\u5f53\u6211\u4eec\u4f7f\u7528CORS\u6765\u8fdb\u884c\u8de8\u57df\u7684\u65f6\u5019\uff0c\u82e5\u60f3\u4f7f\u5176\u643a\u5e26Cookie\u3002"}),"\n",(0,r.jsx)(n.p,{children:"\u670d\u52a1\u7aef\u8bbe\u7f6e"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:"Access-Control-Allow-Credentials: true\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u82e5\u60f3\u8981\u4f7f\u6211\u4eec\u7684Ajax\u6216Fetch\u643a\u5e26Cookie\uff0c\u53ea\u9700\u5982\u6b64\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'// Ajax\nvar xhr = new XMLHttpRequest()\nxhr.withCredentials = true\n\n// Fetch\nfetch(url, {\n    credentials: "include"\n})\n'})}),"\n",(0,r.jsx)(n.p,{children:"Fetch\u7684credentials\u5c5e\u6027\uff0c\u9ed8\u8ba4\u503c\u4e3asame-origin\uff0c\u60f3\u8981\u8de8\u57df\u53d1\u9001Cookie\u5219\u8bbe\u7f6e\u4e3ainclude"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"omit"}),": \u4ece\u4e0d\u53d1\u9001cookies."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"same-origin"}),": \u53ea\u6709\u5f53URL\u4e0e\u54cd\u5e94\u811a\u672c\u540c\u6e90\u624d\u53d1\u9001 cookies\u3001 HTTP Basic authentication \u7b49\u9a8c\u8bc1\u4fe1\u606f.(\u6d4f\u89c8\u5668\u9ed8\u8ba4\u503c,\u5728\u65e7\u7248\u672c\u6d4f\u89c8\u5668\uff0c\u4f8b\u5982safari 11\u4f9d\u65e7\u662fomit\uff0csafari 12\u5df2\u66f4\u6539)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"include"}),": \u4e0d\u8bba\u662f\u4e0d\u662f\u8de8\u57df\u7684\u8bf7\u6c42,\u603b\u662f\u53d1\u9001\u8bf7\u6c42\u8d44\u6e90\u57df\u5728\u672c\u5730\u7684 cookies\u3001 HTTP Basic authentication \u7b49\u9a8c\u8bc1\u4fe1\u606f."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"ajax\u539f\u751f\u652f\u6301abort\uff0cfetch\u9700\u8981\u4f7f\u7528AbortController\u624d\u80fd\u5b9e\u73b0abort"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// ajax\nxhr.abort()\n\n// fetch\nlet controller = new AbortController()\nlet signal = controller.signal\n\nfetch(url, {\n    signal\n})\n\ncontroller.abort()\n\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"fetch\u4e0d\u652f\u6301\u8d85\u65f6\u63a7\u5236"}),"\n",(0,r.jsxs)(n.p,{children:["\u4f55\u4e3a\u8d85\u65f6\u63a7\u5236\u3002\u6bd4\u5982\u6211\u4eec\u8bf7\u6c42\u4e00\u4e2a\u540e\u7aef\u4e0d\u5b58\u5728\u7684\u63a5\u53e3\uff0c\u540c\u65f6\u540e\u7aef\u6ca1\u6709\u505a",(0,r.jsx)(n.code,{children:"fallback"}),"\u5904\u7406\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u8bf7\u6c42\u4e0d\u5230\u8d44\u6e90\uff0c\u5e76\u53ef\u80fd\u7b49\u4e0a\u5341\u591a\u79d2\u624d\u80fd\u770b\u5230\u9519\u8bef\u4fe1\u606f\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// \u5982\u679c2S\u5185\u6ca1\u6709\u6536\u5230\u54cd\u5e94\uff0c\u5219Cancel\u8fd9\u6b21\u901a\u4fe1\nxhr.timeout = 2000 \nxhr.ontimeout = () => {}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u6211\u4eec\u5982\u4f55\u5b9e\u73b0",(0,r.jsx)(n.strong,{children:"fetch\u7684\u8d85\u65f6\u63a7\u5236"}),"\uff0c\u4e0d\u8fc7\u6b64\u65f6\u901a\u4fe1\u4f9d\u7136\u5b58\u5728\uff0c\u5e76\u6ca1\u6709\u624b\u52a8",(0,r.jsx)(n.code,{children:"cancel/abort"}),"\u6389"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'Promise.race([\n    fetch(url),\n    new Promise((resolve, reject) => {\n        setTimeout(() => reject(new Error("request timeout")), 2000)\n    })\n])\n.then(data => {}) // \u8bf7\u6c42\u6210\u529f\n.catch(reason => {}) // \u8bf7\u6c42\u5931\u8d25\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"fetch\u65e0\u6cd5\u68c0\u6d4b\u8bf7\u6c42\u7684\u8fdb\u5ea6(onprogress)"}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>c});var a=t(6540);const r={},s=a.createContext(r);function l(e){const n=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);